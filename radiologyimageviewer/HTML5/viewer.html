
 
<!DOCTYPE html> 
<html> 
<head> 
<title>CTC</title> 
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> 

</head> 
<body> 
<style type="text/css">
	div#b1{
		float: left;
	}

	div#b2{
		width: 512px;
		height: 628px;
//		background-color: aquamarine;
		float: right;
	}
</style>

<div style="width:520px; height:30px">
	<div align="center" >
	  <form name="form1" method="post" action="">
		<label for="list"></label>
	  <select name="list" size="1" id="filelist">
		<option value="08629">08629CTC</option>
		<option value="22118">22118CTC</option>
		<option value="08779">08779CTC</option>
	</select>
	  <input type="button" value="Download" onClick="sel()" />
	  <input id="files" type="file"
		onChange="displayFiles(this.files)" />
	  </form></form> 
	</div>	
</div>
<div style="width:1040px; height:530px">
	<div id="b2">
	<canvas id="test2" width="512" height="628"> 
	your browser can't support &lt;canvas&gt; tag，please change to Chrome or FireFox
	</canvas> 
	</div>
	<div style=" width : 520px; height : 520px; overflow : auto; "> 
	<canvas id="test1" width="512" height="512"> 
	your browser can't support &lt;canvas&gt; tag，please change to Chrome or FireFox
	</canvas> 
	</div>
</div> 

<script type="text/javascript"> 
var pixlearrays;
var slice=225;
var allslice;
var file;
var length = 512*512*2;
var MAX,MIN;

var canvas = document.getElementById("test1");    
var ctx = canvas.getContext("2d");
var c = document.getElementById("test2");    
var ctx2 = c.getContext("2d"); 
    
var width = 512;    
var height = 512;    

//装入图像    
var image = new Image();    
image.onload =imageLoaded;  
var imageData; 
var rayData; 

var startScale =1;
var scale = startScale;
var nxtime;
var flag1=true;
var flag2=true;
var flag3=true;
var flag4=true;
var u1 = 390;
var u2 = 250;
var ss = slice;
var windowing_flag =true;

	canvas.onclick = function(e){
	var e = e ||event;
	u1 = e.clientX -canvas.offsetLeft;
	u2 = e.clientY - canvas.offsetTop;
	console.log(u1);
	ss=slice;
	}

document.onkeydown=function(event){
	var e = event || window.event || arguments.callee.caller.arguments[0];
	flag4=true;
	if(e && e.keyCode==38){ // 按 up
		u2 = u2-5;
		ray();
		console.log("up");
	}else if(e && e.keyCode==40){ // 按 down
		u2 = u2+5;
		ray();
		console.log("down");
	}else if(e && e.keyCode==37){ // 按 left
		u1 = u1-5;
		ray();
		console.log("left");
	}else if(e && e.keyCode==39){ // 按 right
		u1 = u1+5;
		ray();
		console.log("right");
	}else if(e && e.keyCode==33){ // 按 pageup
		ss = ss+5;
		ray();
		console.log("pageup");
	}else if(e && e.keyCode==34){ // 按 pagedown
		ss = ss-5;
		ray();
		console.log("pagedown");
	}else{
		console.log(e.keyCode);
	}	
}


	
	var scrollFunc = function (e) {  
        e = e || window.event;  
        if (e.wheelDelta) {  //判断浏览器IE，谷歌滑轮事件               
            if (e.wheelDelta > 0) { //当滑轮向上滚动时  
				pre();
            }  
            if (e.wheelDelta < 0) { //当滑轮向下滚动时  
                next();
            }  
        } else if (e.detail) {  //Firefox滑轮事件  
            if (e.detail> 0) { //当滑轮向下滚动时  
				next();
            }  
            if (e.detail< 0) { //当滑轮向上滚动时  
				pre();
            }  
        }  
    } 
    /*IE、Opera注册事件*/
    if(document.attachEvent){
        document.attachEvent('onmousewheel',scrollFunc);
 
    }
    //Firefox使用addEventListener添加滚轮事件  
    if (document.addEventListener) {//firefox  
        document.addEventListener('DOMMouseScroll', scrollFunc, false);  
    }  
    //Safari与Chrome属于同一类型
    window.onmousewheel = document.onmousewheel = scrollFunc; 
     /*
    event.wheelDelta 滚动方向
    上：120
    下：-120
    Firefox：event.detail 滚动方向
    上：-3
    下:3
    */ 

		function sel()
	{
		 
		var ff=document.getElementById("filelist"); 
		console.log(ff.value);
		window.open('http://134.175.21.96:8080/do/'+ff.value+'CTC.dat');	 
		 
	}		
       function imageLoaded() {    
          // 将图片画到画布上   
          image.onload=function(){   
          ctx.drawImage(image, 0, 0);       }
          //取图像的像素数组       
          imageData = ctx.getImageData(0, 0, width, height);   
		  
        }  
 
        function displayFiles(files) {
 			
            for (var i = 0; i < files.length; i++) {
                file = files[i];
				
                var dataPre = document.createElement("pre");
 
                var working = document.createElement("span");
                
                var reader = new FileReader();
				allslice=file.size/512/512/2;
								 
                reader.onload = (function(dataTag, workingTag) {
                    return function(e)
                        {
                           imageLoaded(); 
                           hexDump(e.target.result);
                        };
                    })(dataPre, working);
                               
                var blob = file.slice(512*512*2*slice+1, length+512*512*2*slice+1);                 
                reader.readAsArrayBuffer(blob);
				document.getElementById("slices").value=slice;
				
				let reader_volume = new FileReader();
				//allslice=file.size/512/512/2;              
				reader_volume.readAsArrayBuffer(file.slice(1, (allslice-1)*512*512*2+1));
				reader_volume.onload = function () {
				//console.log(this.result);
				pp=new Int16Array(this.result); 
				//console.log(pp);
				}				
               
            }
        
        }  
        
 
        function hexDump(bytes) { 
		
		  if(windowing_flag==false)
		  {
						pixlearray=new Int16Array(bytes); 
			  MIN=pixlearray[0],MAX=pixlearray[0];
			  for (var y = 0; y < imageData.height; y++) {     
				 for (x = 0;x < imageData.width; x++){
					 if(MIN>pixlearray[y * imageData.width + x])
					 {
						 MIN=pixlearray[y * imageData.width + x];
					 }
					 if(MAX<pixlearray[y * imageData.width + x])
					 {
						 MAX=pixlearray[y * imageData.width + x];
					 }
					 
				 }
					 }  
					 var range=MAX-MIN;         
			  for (var y = 0; y < imageData.height; y++) {     
				 for (x = 0;x < imageData.width; x++) { 
				//for (var y = 0; y < 10; y++) {     
				 //for (x = 0;x < 10; x++) {         
					   //index 为当前要处理的像素编号        
					  var index = y * imageData.width + x;   
					   //一个像素占四个字节，即 p 为当前指针的位置       
					  var p = index * 4;                 
					  var b=pixlearray[y * imageData.width + x];                 
	//                  var color=((b-MIN) * 255)/range; 
					  var color=((b-(-3024)) * 255)/6095; 
					  imageData.data[p]=color ; 
					  imageData.data[p+1]=color ;
					  imageData.data[p+2]=color ;
					  imageData.data[p+3]=255 ;    
					  }
				   }
				   
		  }
		else
		{
			  pixlearray=new Int16Array(bytes); 
			  MIN=pixlearray[0],MAX=pixlearray[0];
			  for (var y = 0; y < imageData.height; y++) {     
				 for (x = 0;x < imageData.width; x++){
					 if(MIN>pixlearray[y * imageData.width + x])
					 {
						 MIN=pixlearray[y * imageData.width + x];
					 }
					 if(MAX<pixlearray[y * imageData.width + x])
					 {
						 MAX=pixlearray[y * imageData.width + x];
					 }
					 
				 }
					 }  
					 var range=MAX-MIN;         
			  for (var y = 0; y < imageData.height; y++) {     
				 for (x = 0;x < imageData.width; x++) { 
				//for (var y = 0; y < 10; y++) {     
				 //for (x = 0;x < 10; x++) {         
					   //index 为当前要处理的像素编号        
					  var index = y * imageData.width + x;   
					   //一个像素占四个字节，即 p 为当前指针的位置       
					  var p = index * 4;                 
					  var b=pixlearray[y * imageData.width + x];                 
	//                  var color=((b-MIN) * 255)/range; 
					  var color=((b-(-3024)) * 255)/6095; 
					  imageData.data[p]=color ; 
					  imageData.data[p+1]=color ;
					  imageData.data[p+2]=color ;
					  imageData.data[p+3]=255 ;    
					  }
				   }
				 ctx.putImageData(imageData, 0, 0);             
				}
        
		}
        
         function zoomin() { 
   
		   var canvas2 = document.createElement('canvas');
           canvas2.width=imageData.width;
           canvas2.height=imageData.height;
           //var canvas2 = document.getElementById("test2");  
           canvas2.getContext("2d").putImageData(imageData, 0, 0);
 
 
          scale = scale + 0.1;
 
          var newWidth = width * scale;
          var newHeight = height * scale;
          canvas.width=newWidth;
          canvas.height=newHeight;
    
          ctx.save();
          //ctx.translate(-((newWidth-preWidth)/2), -((newHeight-preHeight)/2));
          ctx.scale(scale, scale);
          ctx.clearRect(0, 0, newWidth, newHeight);
          ctx.drawImage(canvas2, 0, 0);
          ctx.restore();
		  
         }
         
          function zoomout() {          
           var canvas2 = document.createElement('canvas');
           canvas2.width=imageData.width;
           canvas2.height=imageData.height;
           //var canvas2 = document.getElementById("test2");  
           canvas2.getContext("2d").putImageData(imageData, 0, 0);
 
          scale = scale - 0.1;
 
          var newWidth = width * scale;
          var newHeight = height * scale;
          canvas.width=newWidth;
          canvas.height=newHeight;
    
          ctx.save();
          ctx.clearRect(0, 0, newWidth, newHeight);          
          ctx.scale(scale, scale);          
          ctx.drawImage(canvas2, 0, 0);
          ctx.restore();	  
     
         }
         
		 function Reset() { 	 
		  for (var y = 0; y < imageData.height; y++) {     
                for (x = 0;x < imageData.width; x++) {
					
					var index = y * imageData.width + x;
					var p = index * 4;  
					var b=pixlearray[y * imageData.width + x];					 
					var color=(b-(-3024)) /(6095)*255;				    
					imageData.data[p]=color ; 
					imageData.data[p+1]=color ;
					imageData.data[p+2]=color ;
					imageData.data[p+3]=255 ;					 
				}
			 }
		 
		   ctx.putImageData(imageData, 0, 0);
       
           var canvas2 = document.createElement('canvas');
           canvas2.width=imageData.width;
           canvas2.height=imageData.height;
           //var canvas2 = document.getElementById("test2");  
           canvas2.getContext("2d").putImageData(imageData, 0, 0);
 
          scale =1;
 
          var newWidth = width * scale;
          var newHeight = height * scale;
          canvas.width=newWidth;
          canvas.height=newHeight;
    
          ctx.save();
          ctx.clearRect(0, 0, newWidth, newHeight);          
          ctx.scale(scale, scale);          
          ctx.drawImage(canvas2, 0, 0);          
		  ctx.restore();
     
         }
        function pre() {
         	  
		  if(scale!=1)
          {
           var canvas2 = document.createElement('canvas');
           canvas2.width=imageData.width;
           canvas2.height=imageData.height;
           canvas2.getContext("2d").putImageData(imageData, 0, 0);
 
           scale = 1
 
          var newWidth = width * scale;
          var newHeight = height * scale;
          canvas.width=newWidth;
          canvas.height=newHeight;
    
          ctx.save();
          ctx.clearRect(0, 0, newWidth, newHeight);
          ctx.scale(scale, scale);          
          ctx.drawImage(canvas2, 0, 0);
          ctx.restore();
          }
         
         slice=slice-1;
         if(slice<0)
           slice=0;
		   
		   
		if(windowing_flag==true)
		{
           
           var dataPre = document.createElement("pre");
           var working = document.createElement("span");
           
               var reader = new FileReader();
                reader.onload = (function(dataTag, workingTag) {
                    return function(e)
                        {
                           hexDump(e.target.result);
                        };
                    })(dataPre, working);
                
               
                var blob = file.slice(512*512*2*slice+1, length+512*512*2*slice+1);
                reader.readAsArrayBuffer(blob);
				document.getElementById("slices").value=slice;	

		}				
		 else
		 {
           var dataPre = document.createElement("pre");
           var working = document.createElement("span");
           
               var reader = new FileReader();
                reader.onload = (function(dataTag, workingTag) {
                    return function(e)
                        {
                           hexDump(e.target.result);
                        };
                    })(dataPre, working);
                
               
                var blob = file.slice(512*512*2*slice+1, length+512*512*2*slice+1);
                reader.readAsArrayBuffer(blob);
				document.getElementById("slices").value=slice;	
			
			windowing_flag=true;
			windowing();
		 
		 }		
		
		
		
		
       }
         
        function next() {       
         if(scale!=1)
          {
           var canvas2 = document.createElement('canvas');
           canvas2.width=imageData.width;
           canvas2.height=imageData.height;
           canvas2.getContext("2d").putImageData(imageData, 0, 0);
 
           scale = 1
 
          var newWidth = width * scale;
          var newHeight = height * scale;
          canvas.width=newWidth;
          canvas.height=newHeight;
    
          ctx.save();
          ctx.clearRect(0, 0, newWidth, newHeight);
          ctx.scale(scale, scale);          
          ctx.drawImage(canvas2, 0, 0);
          ctx.restore();
          }
        
          
         slice=slice+1;
         if(slice>allslice-1)
           slice=allslice-1;
		   
		   
		 if(windowing_flag==true)
		 {
			var dataPre = document.createElement("pre");
			var working = document.createElement("span");

			var reader = new FileReader();
			
			reader.onload = (function(dataTag, workingTag) {
				return function(e)
					{
					   hexDump(e.target.result);
					};
				})(dataPre, working);
                

			var blob = file.slice(512*512*2*slice+1, 512*512*2*slice+1+length);
			reader.readAsArrayBuffer(blob);			   
			document.getElementById("slices").value=slice;
	

				console.log("dfkjalsdjakl");

		 }  
		 else
		 {
		 	var dataPre = document.createElement("pre");
			var working = document.createElement("span");

			var reader = new FileReader();
			
			reader.onload = (function(dataTag, workingTag) {
				return function(e)
					{
					   hexDump(e.target.result);
					};
				})(dataPre, working);
                

			var blob = file.slice(512*512*2*slice+1, 512*512*2*slice+1+length);
			reader.readAsArrayBuffer(blob);			   
			document.getElementById("slices").value=slice;
			
			windowing_flag=true;
			windowing();
		 
		 }  
        }
		 
		 function  filter(){			 
			 obj=document.getElementById('filterlist');
			 filterwidth=obj.value;
			 filterheight=obj.value;			   
			  
			  for(var x = (filterwidth-1)/2; x < imageData.height-(filterwidth-1)/2; x++){
			  for(var y = (filterheight-1)/2; y < imageData.width-(filterheight-1)/2; y++){
				  var tempArray = [];
				  for(var i=-((filterwidth-1)/2);i<=(filterwidth-1)/2;i++){
					  for(var j=-((filterheight-1)/2);j<=(filterheight-1)/2;j++)
					  {
						  tempArray.push(pixlearray[(j+y)*imageData.width+i+x]);
					  }
					}
					  
					//冒泡排序
				 	do{
						var loop=0;
						for(i=0;i<tempArray.length-1;i++)
						{
							if(tempArray[i]>tempArray[i+1])
							{
								var tempChange=tempArray[i];
								tempArray[i]=tempArray[i+1];
								tempArray[i+1]=tempChange;
								loop=1;
							}
						}
						
					}while(loop);
					 
					 var index = y*imageData.width+x; 								 
       
                     var p = index * 4;
				 	 var color=(tempArray[Math.round(tempArray.length/2)]-MIN)*255/(MAX-MIN);					 
					 imageData.data[p]=color ; 
              	     imageData.data[p+1]=color ;
              	     imageData.data[p+2]=color ;
              	     imageData.data[p+3]=255 ;
           			 
			  }
			  }
			  ctx.putImageData(imageData, 0, 0);
			  
			  var canvas2 = document.createElement('canvas');
           	  canvas2.width=imageData.width;
              canvas2.height=imageData.height;
              canvas2.getContext("2d").putImageData(imageData, 0, 0);
 
              var newWidth = width * scale;
              var newHeight = height * scale;
              canvas.width=newWidth;
              canvas.height=newHeight;
     
              ctx.save();
              ctx.scale(scale, scale);
              ctx.clearRect(0, 0, newWidth, newHeight);
              ctx.drawImage(canvas2, 0, 0);
              ctx.restore(); 
		 }
		 
		 function thresholding(){			 
			 var thresh=document.getElementById("thresh").value;			  
			 for (var y = 0; y < imageData.height; y++) {     
                for (x = 0;x < imageData.width; x++) {
					
					var index = y * imageData.width + x;
					var p = index * 4;  
					var b=pixlearray[y * imageData.width + x];					 
					var color=(b-MIN) /(MAX-MIN)*255;					 
				    color=color>thresh ? 255:0  
					imageData.data[p]=color ; 
					imageData.data[p+1]=color ;
					imageData.data[p+2]=color ;
					imageData.data[p+3]=255 ;					 
				}
			 } 
		   ctx.putImageData(imageData, 0, 0);
             
           var canvas2 = document.createElement('canvas');
           canvas2.width=imageData.width;
           canvas2.height=imageData.height;
           canvas2.getContext("2d").putImageData(imageData, 0, 0);
 
          var newWidth = width * scale;
          var newHeight = height * scale;
          canvas.width=newWidth;
          canvas.height=newHeight;
    
          ctx.save();
          ctx.scale(scale, scale);
          ctx.clearRect(0, 0, newWidth, newHeight);
          ctx.drawImage(canvas2, 0, 0);
          ctx.restore(); 
		  
			 
		 }
         
        function windowing() {
		  
			if(windowing_flag==true)
			{
				var time1=new Date().getTime();
				var c= document.getElementById("center").value;
				var w= document.getElementById("width").value;

				var min=c-w/2;
				var range=w;
				for (var y = 0; y < imageData.height; y++) {     
					for (x = 0;x < imageData.width; x++) {             
						var index = y * imageData.width + x;         
						var p = index * 4;
						var b=pixlearray[y * imageData.width + x];
						var color=((b-min) * 255)/range;
						color = color>255 ? 255:color;    
						color= color<0 ? 0:color;
						imageData.data[p]=color ; 
						imageData.data[p+1]=color ;
						imageData.data[p+2]=color ;
						imageData.data[p+3]=255 ;    
					}
				}

				ctx.putImageData(imageData, 0, 0);

				var canvas2 = document.createElement('canvas');
				canvas2.width=imageData.width;
				canvas2.height=imageData.height;
				canvas2.getContext("2d").putImageData(imageData, 0, 0);

				var newWidth = width * scale;
				var newHeight = height * scale;
				canvas.width=newWidth;
				canvas.height=newHeight;

				ctx.save();
				ctx.scale(scale, scale);
				ctx.clearRect(0, 0, newWidth, newHeight);
				ctx.drawImage(canvas2, 0, 0);
				ctx.restore();   
		  
				windowing_flag=false;
			}
			else
			{
				windowing_flag=true;
				Reset();

			}
          

        } 
		  
		  function edge_detect(){			 
		 	  ways=document.getElementById('edgelist');
			  if(ways.value==1) //choose sobel
			  {
				  var gx=0;
				  var gy=0;
				  var temp1=[];
				  var temp2=[];
				  for(var x=1;x<511;x++)
				  {
					  for(var y=1;y<511;y++)
					  {
						  gx=Math.abs(pixlearray[x+1+(y-1)*imageData.width]+2*pixlearray[x+1+y*imageData.width]+pixlearray[x+1+(y+1)*imageData.width]-pixlearray[x-1+(y-1)*imageData.width]-2*pixlearray[x-1+y*imageData.width]-pixlearray[x-1+(y+1)*imageData.width]);
						  gy=Math.abs(pixlearray[x-1+(y+1)*imageData.width]+2*pixlearray[x+(y+1)*imageData.width]+pixlearray[x+1+(y+1)*imageData.width]-pixlearray[x-1+(y-1)*imageData.width]-2*pixlearray[x+(y-1)*imageData.width]-pixlearray[x+1+(y-1)*imageData.width]);
						  temp1.push(gx);
						  temp2.push(gy);						  					  
						  }
					  }
					  var min1=temp1[0];
					  var max1=temp1[0];
					  var min2=temp2[0];
					  var max2=temp2[0];
					  for(var i=0;i<temp1.length;i++)
					  {
						  if(min1>temp1[i]) min1=temp1[i];
						  if(max1<temp1[i]) max1=temp1[i];
					  }
					  for(var i=0;i<temp2.length;i++)
					  {
						  if(min2>temp2[i]) min2=temp2[i];
						  if(max2<temp2[i]) max2=temp2[i];
					  }
					  for(var j=0;j<temp1.length;j++){
						  temp1[j]=(temp1[j]-min1)/(max1-min1)*255;
						  temp2[j]=(temp2[j]-min2)/(max2-min2)*255;
					  }
					  var count=0;
					  for(var x=1;x<511;x++){
						  for(var y=1;y<511;y++){
							  var index = y * imageData.width + x;
							  var p = index * 4;
							  var b= (temp1[count]+temp2[count]);
							//  b=(b>70)?255:0;
							  
							   
							  imageData.data[p]=b ;
							  imageData.data[p+1]=b ;
							  imageData.data[p+2]=b ;	
							  imageData.data[p+3]=255;
							  count=count+1;
						  }
					  } 
			  }
			  else if(ways.value==2)//choose laplace
			  {
				  
				   temp3=[];
				   for(var x = 1; x < imageData.height-1; x++){
					   for(var y = 1; y < imageData.width-1; y++){
						   var g=0;				  
						   g=Math.abs(8*pixlearray[y*imageData.width+x]-pixlearray[y*imageData.width+x-1]-pixlearray[y*imageData.width+x+1]-pixlearray[(y-1)*imageData.width+x]-pixlearray[(y+1)*imageData.width+x]-pixlearray[(y-1)*imageData.width+x-1]-pixlearray[imageData.width*(y-1)+x+1]-pixlearray[(y+1)*imageData.width+x-1]-pixlearray[(y+1)*imageData.width+x+1]);	
						   temp3.push(g);  
					   }
				   }
				   var min3=temp3[0];
				   var max3=temp3[0];
				   for(var i=0;i<temp3.length;i++)
				   {
					   if(min3>temp3[i]) min3=temp3[i];
					   if(max3<temp3[i]) max3=temp3[i];
				   }
				   for(var i=0;i<temp3.length;i++)
				   {
					   temp3[i]=Math.round((temp3[i]-min3)/(max3-min3)*255);
				   }
				   var count=0;
				   for(var x = 1; x < imageData.height-1; x++){
					   for(var y = 1; y < imageData.width-1; y++){
						   var index = y * imageData.width + x;
						   var p = index * 4;
						   var color=temp3[count];
						   imageData.data[p]=color;
						   imageData.data[p+1]=color;
						   imageData.data[p+2]=color;
						   imageData.data[p+3]=255;
						   count=count+1;
					   }
				   }
			  }
			  else if(ways.value==3)//choose canny
			  {
				  
				  var temp4=[];
				  for(var x = 1; x < imageData.height-1; x++){
					   for(var y = 1; y < imageData.width-1; y++){
						   var g=0;						 
						   g=Math.abs(pixlearray[imageData.width*(y-1)+x+1]+pixlearray[imageData.width*y+x+1]+pixlearray[(y+1)*imageData.width+x+1]-pixlearray[imageData.width*(y-1)+x-1]-pixlearray[imageData.width*y+x-1]-pixlearray[imageData.width*(y+1)+x-1]);
						   temp4.push(g);   
						    
						   }
				   }
				   var min4=temp4[0];
				   var max4=temp4[0];
				   for(var i=0;i<temp4.length;i++)
				   {
					   if(min4>temp4[i]) min4=temp4[i];
					   if(max4<temp4[i]) max4=temp4[i];
				   }
				   for(var i=0;i<temp4.length;i++)
				   {
					   temp4[i]=Math.round((temp4[i]-min4)/(max4-min4)*255);
				   }
				   var count=0;
				   for(var x = 1; x < imageData.height-1; x++)
				   {
					   for(var y = 1; y < imageData.width-1; y++)
					   {
						   
						   var index = y * imageData.width + x;
						   var p = index * 4;
						   var color=temp4[count];
						   imageData.data[p]=color; 
						   imageData.data[p+1]=color;
						   imageData.data[p+2]=color;
						   imageData.data[p+3]=255;
						   count=count+1;
						}
					}	 
				  
			  }else if(ways.value==4)
			  {
				  var temp5=[];
				  for(var x = 1; x < imageData.height-1; x++){
					   for(var y = 1; y < imageData.width-1; y++){
						   var g=0;						   
						   g=Math.abs(pixlearray[imageData.width*(y+1)+x+1]-pixlearray[imageData.width*y+x])+Math.abs(pixlearray[(y+1)*imageData.width+x]-pixlearray[y*imageData.width+x+1]);
						   temp5.push(g);
					   }
				  }
				  var min5=temp5[0];
				  var max5=temp5[0];
				  for(var i=0;i<temp5.length;i++)
				  {
					  if(min5>temp5[i]) min5=temp5[i];
					  if(max5<temp5[i]) max5=temp5[i];
				  }
				  for(var i=0;i<temp5.length;i++)
				  {
					  temp5[i]=Math.round((temp5[i]-min5)/(max5-min5)*255);
				  }
				  var count=0;
				  for(var x = 1; x < imageData.height-1; x++){
					   for(var y = 1; y < imageData.width-1; y++){
						   var index = y * imageData.width + x;
						   var p = index * 4;
						   var color=temp5[count];
						   imageData.data[p]=color; 
						   imageData.data[p+1]=color;
						   imageData.data[p+2]=color;
						   imageData.data[p+3]=255;
						   count=count+1;
					   }
				  } 	   
				  
			  }
		    
			  
			  ctx.putImageData(imageData, 0, 0);
             
           	  var canvas2 = document.createElement('canvas');
           	  canvas2.width=imageData.width;
          	  canvas2.height=imageData.height;
              canvas2.getContext("2d").putImageData(imageData, 0, 0);
 
			  var newWidth = width * scale;
			  var newHeight = height * scale;
			  canvas.width=newWidth;
			  canvas.height=newHeight;
		
			  ctx.save();
			  ctx.scale(scale, scale);
			  ctx.clearRect(0, 0, newWidth, newHeight);
			  ctx.drawImage(canvas2, 0, 0);
			  ctx.restore();  
			 
		  }
		  function reconstruct(){
			  if(window.localStorage)
			  {
				  localStorage.name=document.getElementById("filelist").value;
				  location.href = 'http://134.175.21.96:8080/radiologyimageviewer/HTML5/reconstruct.html';   
			  	 // location.href = 'http://134.175.21.96:8080/datatest/reconstruct.html';  
			  }else
			  {
				  alert("Not support");
			  }
		  }
		  function fly_through(){
			  
			  var ff=document.getElementById("filelist");  
			  window.open('http://134.175.21.96:8080/radiologyimageviewer/HTML5/inner_flythrough'+ff.value+'.html');  
		  
			//window.open('http://203.195.157.19:80/datatest/inner_flythrough'+ff.value+'.html'); 
		  
		  }
		  
		function mip(){
			if(flag1==true){
				var depth = allslice-1;
				var imageWidth = 512;
				var imageHeight = 512;
				
				imageData = ctx2.getImageData(0, 0, 512, allslice-1);   
				c.width = 512;
				c.height = allslice-1;
				
				var MapData=new Array();
				for (var d=0; d<depth; d++)
				{
					MapData[d]=new Array();
					for (var h=0; h<imageHeight; h++)
					{
						MapData[d][h]=new Array();
						for (var w=0; w<imageWidth; w++)
						{ 
							MapData[d][h][w] = pp[d*512*512 + h*512 + w];
						}
					}
				}
				for (var i1=0; i1<depth; i1++)
				{
					for (var i2=0; i2<imageHeight; i2++)
					{
						for (var i3=0; i3<imageWidth; i3++)
						{ 
							if(MapData[i1][i2][i3]<-1024)
								MapData[i1][i2][i3] = -1024;
						}//mip 只投影骨头		
					}
				}
				var mip_Data=new Array();
				for(var d=0;d<depth;d++)
				{
					mip_Data[d]=new Array();
					for(var w=0;w<imageWidth;w++)
					{
						var blank = -9999;
						for (var h=0; h<imageHeight; h++)
						{
							if(MapData[d][h][w]>blank) 
							{
								blank = MapData[d][h][w];
							}
						}
						mip_Data[d][w]=blank;
					}                
				}			

				var min = 9999;
				var max = -9999;
				for(var d=0;d<depth;d++)
				{
					for(var w=0;w<imageWidth;w++)
					{
						if(mip_Data[d][w] < min) 
							min = mip_Data[d][w];
						if(mip_Data[d][w] > max) 
							max = mip_Data[d][w];
					}
				}							
			
			
				var range=max-min;         
				for (var y = 0; y < imageData.height; y++) {     
					for (var x = 0;x < imageData.width; x++) {       
						//index 为当前要处理的像素编号        
						var index = y * imageData.width + x;   
						//一个像素占四个字节，即 p 为当前指针的位置       
						var p = index * 4;  
						var b=mip_Data[y][x];                 
						//                 var b=pixlearray[y * imageData.width + x];                 
						var color=((b-min) * 255)/range; 
						imageData.data[p]=color ; 
						imageData.data[p+1]=color ;
						imageData.data[p+2]=color ;
						imageData.data[p+3]=255 ;    
					}
				}
				ctx2.putImageData(imageData, 0, 0);   
				flag1=false;
			}			
			else{
				flag1=true;
				c.height=c.height; 
			}	
		}	
/*		
		function minip(){
			if(flag2==true){
				var depth = allslice-1;
				var imageWidth = 512;
				var imageHeight = 512;
				
				imageData = ctx2.getImageData(0, 0, 512, allslice-1);   
				c.width = 512;
				c.height = allslice-1;
				
				var MapData=new Array();
				for (var d=0; d<depth; d++)
				{
					MapData[d]=new Array();
					for (var h=0; h<imageHeight; h++)
					{
						MapData[d][h]=new Array();
						for (var w=0; w<imageWidth; w++)
						{ 
							MapData[d][h][w] = pp[d*512*512 + h*512 + w];
						}
					}
				}
				for (var i1=0; i1<depth; i1++)
				{
					for (var i2=0; i2<imageHeight; i2++)
					{
						for (var i3=0; i3<imageWidth; i3++)
						{ 
							if(MapData[i1][i2][i3]<1000)
								MapData[i1][i2][i3] = 3071;
						}		
					}
				}
				var minip_Data=new Array();
				for(var d=0;d<depth;d++)
				{
					minip_Data[d]=new Array();
					for(var w=0;w<imageWidth;w++)
					{
						var blank = 9999;
						for (var h=0; h<imageHeight; h++)
						{
							if(MapData[d][h][w]<blank) 
							{
								blank = MapData[d][h][w];
							}
						}
						minip_Data[d][w]=blank;
					}                
				}			

				var min = 9999;
				var max = -9999;
				for(var d=0;d<depth;d++)
				{
					for(var w=0;w<imageWidth;w++)
					{
						if(minip_Data[d][w] < min) 
							min = minip_Data[d][w];
						if(minip_Data[d][w] > max) 
							max = minip_Data[d][w];
					}
				}							
			
			
				var range=max-min;         
				for (var y = 0; y < imageData.height; y++) {     
					for (var x = 0;x < imageData.width; x++) {       
						//index 为当前要处理的像素编号        
						var index = y * imageData.width + x;   
						//一个像素占四个字节，即 p 为当前指针的位置       
						var p = index * 4;  
						var b=minip_Data[y][x];                 
						//                 var b=pixlearray[y * imageData.width + x];                 
						var color=((b-min) * 255)/range; 
						imageData.data[p]=color ; 
						imageData.data[p+1]=color ;
						imageData.data[p+2]=color ;
						imageData.data[p+3]=255 ;    
					}
				}
				ctx2.putImageData(imageData, 0, 0);   
				flag2=false;
			}			
			else{
				flag2=true;
				c.height=c.height; 
			}	
		}				  
		function avgip(){
			if(flag3==true){
				var depth = allslice-1;
				var imageWidth = 512;
				var imageHeight = 512;
				
				imageData = ctx2.getImageData(0, 0, 512, allslice-1);   
				c.width = 512;
				c.height = allslice-1;
				
				var MapData=new Array();
				for (var d=0; d<depth; d++)
				{
					MapData[d]=new Array();
					for (var h=0; h<imageHeight; h++)
					{
						MapData[d][h]=new Array();
						for (var w=0; w<imageWidth; w++)
						{ 
							MapData[d][h][w] = pp[d*512*512 + h*512 + w];
						}
					}
				}
			
				var avgip_Data=new Array();
				for(var d=0;d<depth;d++)
				{
					avgip_Data[d]=new Array();
					for(var w=0;w<imageWidth;w++)
					{
						var blank = 0;
						for (var h=0; h<imageHeight; h++)
						{
							blank = blank + MapData[d][h][w];							
						}
						avgip_Data[d][w]=blank/imageHeight;
					}                
				}			

				var min = 9999;
				var max = -9999;
				for(var d=0;d<depth;d++)
				{
					for(var w=0;w<imageWidth;w++)
					{
						if(avgip_Data[d][w] < min) 
							min = avgip_Data[d][w];
						if(avgip_Data[d][w] > max) 
							max = avgip_Data[d][w];
					}
				}							
			
			
				var range=max-min;         
				for (var y = 0; y < imageData.height; y++) {     
					for (var x = 0;x < imageData.width; x++) {       
						//index 为当前要处理的像素编号        
						var index = y * imageData.width + x;   
						//一个像素占四个字节，即 p 为当前指针的位置       
						var p = index * 4;  
						var b=avgip_Data[y][x];                 
						//                 var b=pixlearray[y * imageData.width + x];                 
						var color=((b-min) * 255)/range; 
						imageData.data[p]=color ; 
						imageData.data[p+1]=color ;
						imageData.data[p+2]=color ;
						imageData.data[p+3]=255 ;    
					}
				}
				ctx2.putImageData(imageData, 0, 0);   
				flag3=false;
			}			
			else{
				flag3=true;
				c.height=c.height; 
			}	
		}				  
*/
			  
		function measure(){	
			canvas.onmousedown = function(e){
			var e = e ||event;
			ox = e.clientX -canvas.offsetLeft;
			oy = e.clientY - canvas.offsetTop;
			ctx.moveTo(ox,oy);
			}

			document.onmouseup  = function(e){
			ox2 = e.clientX -canvas.offsetLeft;
			oy2 = e.clientY - canvas.offsetTop;
			ctx.lineTo(ox2,oy2);
			ctx.strokeStyle='rgb(255,0,0)';
			ctx.stroke();
			document.onmousemove =null;
			document.onmouseup = null;			
			var distance=Math.sqrt((ox-ox2)*(ox-ox2)+(oy-oy2)*(oy-oy2));
			distance = distance.toFixed(2); 
			ctx.textAlign = "start"
			ctx.fillStyle = "#ff0000"
//				ctx.fillText(ox,ox,oy);
//            	ctx.fillText(ox2,ox2,oy2);
			ctx.fillText(distance,ox,oy);
			}
		}	
		

			//创建矩形之方法1 moveTo(),lineTo()
			function createRect1(context,sx,sy,width,height){
 
				context.beginPath();
				context.moveTo(sx,sy);
				context.lineTo(sx+width,sy);
				context.lineTo(sx+width,sy+height);
				context.lineTo(sx,sy+height);
				context.closePath();
				
				context.fillStyle = "#ff0000";
				context.strokeStyle = 'rgb(255,0,0)';
 
				context.stroke();
 
			}	

		function ray(){
			if(flag4==true){
				var depth = allslice-1;
				var imageWidth = 512;
				var imageHeight = 512;
				
				//ss = slice;
			
				var hh = 200;
				var ww = 200;
				var dd = 200;	
				if(ss>depth-50)
					ss=depth-50;
				if(u1<50)
					u1=50;
				else if(u1>462)
					u1=462;
				else if(u2<50)
					u2=50;
				else if(u2>462)
					u2=462;					

				createRect1(ctx,u1-50,u2-50,100,100);
				
				rayData = ctx2.getImageData(0, 0, ww, hh);   
				c.width = ww;
				c.height = hh;
				
				var MapData=new Array();
				for (var d=0; d<depth; d++)
				{
					MapData[d]=new Array();
					for (var h=0; h<imageHeight; h++)
					{
						MapData[d][h]=new Array();
						for (var w=0; w<imageWidth; w++)
						{ 
							MapData[d][h][w] = pp[d*512*512 + h*512 + w];
						}
					}
				}
				
				var min = 9999;
				var max = -9999;
				var raydata=new Array();
				for(var y=0;y<100;y++)
				{
					raydata[y]=new Array();
					for(var z=0;z<100;z++)
					{
						raydata[y][z]=new Array();
						for(var x=0; x<100; x++)
						{
							raydata[y][z][x] = Number(MapData[y+ss][z+u2-50][x+u1-50]);
							if(raydata[y][z][x] < min) 	min = raydata[y][z][x];
							if(raydata[y][z][x] > max)  max = raydata[y][z][x];
						}
					}                
				}					
				
				var range = max - min;
				for(var y=0;y<100;y++)
					for(var z=0;z<100;z++)
						for(var x=0; x<100; x++)
						{
							raydata[y][z][x] = (Number(raydata[y][z][x])-min) * 255 / range;
						}				
				
				var ct=new Array();
				for(var i=0;i<ww;i++)
				{
					ct[i]=new Array();
					for(var j=0;j<hh;j++)
					{
						//Vector3 datapos = new Vector3(0,(float)(j)/2,(float)(i)/2);	
						var datapos=new Array(0,Number(j)/2,Number(i)/2);

						ct[i][j] = Composite(datapos, raydata);
					}
				}	
			
//smooth
			for(var ii=1;ii<200-1;ii++)
       			for(var jj=1;jj<200-1;jj++)
				{				
					 var grey1= ct[ii-1][jj-1];
					 var grey2= ct[ii-1][jj];
					 var grey3= ct[ii-1][jj+1];
					 var grey4= ct[ii][jj-1];			 
					 var grey5= ct[ii][jj];
					 var grey6= ct[ii][jj+1];
					 var grey7= ct[ii+1][jj-1];
					 var grey8= ct[ii+1][jj];
					 var grey9= ct[ii+1][jj+1];
					 var averageGrey=Number(grey1+grey2+grey3+grey4+grey5+grey6+grey7+grey8+grey9)/9;
					 ct[ii][jj]=averageGrey;
				}				
						
			
				for (var i1 = 0; i1 < 200; i1++) {     
					for (var i2 = 0;i2 < 200; i2++) {       
						//index 为当前要处理的像素编号        
						var index = i1 * rayData.width + i2;   
						//一个像素占四个字节，即 p 为当前指针的位置       
						var p = index * 4;  
						//var b=pixlearray[y * imageData.width + x];                 
						var color = Math.round(ct[i2][i1]); 
						color = color>255 ? 255:color;    
						color= color<0 ? 0:color;						
						rayData.data[p]=color ; 
						rayData.data[p+1]=color ;
						rayData.data[p+2]=color ;
						rayData.data[p+3]=255 ;    
					}
				}
				ctx2.putImageData(rayData, 0, 0);   
				flag4=false;
			}			
			else{
				flag4=true;
				c.height=c.height; 
			}	
		}		


		function Composite(Vector3,raydata)
		{
			var eye=new Array(-1000,50,50);		 
			
			var samplepos=new Array(Vector3[0],Vector3[1],Vector3[2]);
			var cumalpha = 0;
			var samplealpha; //透明度
			var stepsize = 1;//采样步长
			var samplecolor;
			
			var C_out=0;
			var C_in=0;
			
			var dir=new Array(Vector3[0]-eye[0],Vector3[1]-eye[1],Vector3[2]-eye[2]);
			var l=Math.sqrt(Number(dir[0]*dir[0]+dir[1]*dir[1]+dir[2]*dir[2]));
			dir[0]=dir[0]/l;
			dir[1]=dir[1]/l;
			dir[2]=dir[2]/l;
			
			while((cumalpha<1) && (samplepos[0]<100) && (samplepos[1]<100) && (samplepos[2]<100) && (samplepos[0]>=0) && (samplepos[1]>=0) && (samplepos[2]>=0)) {	
				samplecolor = TrInterpolation(samplepos, raydata);//三线性插值获得采样点处的颜色及不透明度
			
				//下一个采样点			
				samplepos[0]+=dir[0]*stepsize;
				samplepos[1]+=dir[1]*stepsize;
				samplepos[2]+=dir[2]*stepsize;			
			
				if(samplecolor<7 || samplecolor==0) // density=0;
				{
					continue;
				}	

				//合成颜色及不透明度,采用的是从前到后的合成公式
				samplealpha = samplecolor/255;
				

				C_out = C_in*(samplealpha) + samplecolor*(1-samplealpha);		
				if(C_out>=255){
					return C_in;
					}				
				C_in = C_out;				

				cumalpha = cumalpha+samplealpha;				
			}		
			
			return C_out;			
		}		 		 

		function TrInterpolation(samplepos,raydata) 
		{
			var x0, y0, z0, x1, y1 ,z1;
			var fx=new Number();
			var fy=new Number();			
			var fz=new Number();			
			
			x0=Math.floor(samplepos[0]);//整数部分
			y0=Math.floor(samplepos[1]);
			z0=Math.floor(samplepos[2]);
			fx=samplepos[0]-x0;//小数部分

			fy=samplepos[1]-y0;
			fz=samplepos[2]-z0;
			
			if(x0==99 || y0==99 || z0==99){
				x1=x0;
				y1=y0;
				z1=z0;
			}
			else{
				x1=x0+1;
				y1=y0+1;
				z1=z0+1;
			}
//			System.out.println("x0:"+x0+" y0:"+y0+" z0:"+z0);

			var p0 = raydata[x0][y0][z0]*(1-fz)+raydata[x0][y0][z1]*fz;
			var p1 = raydata[x0][y1][z0]*(1-fz)+raydata[x0][y1][z1]*fz;
			var p2 = raydata[x1][y0][z0]*(1-fz)+raydata[x1][y0][z1]*fz;
			var p3 = raydata[x1][y1][z0]*(1-fz)+raydata[x1][y1][z1]*fz;
			var p4 = p0*(1-fy)+p1*fy;
			var p5 = p2*(1-fy)+p3*fy;
			var p6 = p4*(1-fx)+p5*fx;
			
			return p6;	
		}			
		   
      
  </script> 

<div style="width:512px"> 
<table width="500" border="5" align="center" cellpadding="0" cellspacing="4">
  <tr>
    <td>
    	<input type="button" value="Previous" onclick="pre()" />
   	 	<input type="button" value="Next" onclick="next()"  />
    	<label>slice:<input type="text" id="slices" style="border:none" size="5"/></label> 
    </td>
    <td>
    	<input type="button" value="Zoomin" onclick="zoomin()" /> 
		<input type="button" value="Zoomout" onclick="zoomout()"/> 
<!--		<input type="button" value="reset" onclick="Reset()"/>-->
    </td>
  </tr>
  <tr>


  </tr>

  </tr>
  <tr>
    <td><input type="button" value="Mip" onClick="mip()">
      <input type="button" value="volume render" onClick="ray()"></td>
    <td><input type="button" value="Measure" onClick="measure()"></td>
  </tr>
  <tr>
    <td>
    	<label>Window center:
		<input type="text" id="center" size="5">
		</label>
    </td>
    <td>
    	<label>Window width:
		<input type="text" id="width" size="5">
		</label>
        <input type="button" value="OK" onClick="windowing()"/> </form> 
    </td>
  </tr>
  <tr>
    <td><input type="button" value="Reconstruction" onClick="reconstruct()"></td>
    <td><input type="button" value="Fly-through" onClick="fly_through()"></td>
  </tr>
</table>
<table width="512" border="0">
   
</table>

</div>
 
</body> 
 
</html> 
